<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Beny·Guo's blog"><meta name="keywords" content="前端,后端"><title>linux尽量避免使用system()函数,用popen()代替 | Beny's Diary</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/blog/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/blog/favicon.ico"><link rel="bookmark" href="/blog/favicon.ico"><link rel="apple-touch-icon" href="/blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/blog/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">linux尽量避免使用system()函数,用popen()代替</h1><a id="logo" href="/blog/.">Beny's Diary</a><p class="description">记录点滴</p></div><div id="nav-menu"><a href="/blog/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/blog/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/blog/about/"><i class="fa fa-user"> 关于</i></a><a href="/blog/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">linux尽量避免使用system()函数,用popen()代替</h1><div class="post-meta"><a href="/blog/post/9ca378c1.html#comments" class="comment-count"><!----></a><p><span class="date">Mar 13, 2018</span><span><a href="/blog/categories/后端/" class="category">后端</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>linux尽量避免使用system。<br>曾经的曾经，被<code>system()</code>函数折磨过，之所以这样，是因为对<code>system()</code>函数了解不够深入。只是简单的知道用这个函数执行一个系统命令，这远远不够，它的返回值、它所执行命令的返回值以及命令执行失败原因如何定位，这才是重点。当初因为这个函数风险较多，故抛弃不用，改用其他的方法。这里先不说我用了什么方法，这里必须要搞懂system()函数，因为还是有很多人用了<code>system()</code>函数，有时你不得不面对它。</p>
<p>先来看一下<code>system()</code>函数的简单介绍：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">int system(const char *command);</span><br><span class="line">system() executes a command specified in command by calling /bin/sh -c command, and returns after the command has been completed. During execution of the command, SIGCHLD will be blocked, and SIGINT and SIGQUIT will be ignored.</span><br></pre></td></tr></table></figure></p>
<p><code>system()</code>函数调用<code>/bin/sh</code>来执行参数指定的命令，<code>/bin/sh</code> 一般是一个软连接，指向某个具体的shell，比如bash，-c 选项是告诉shell从字符串 command 中读取命令；<br>在该command执行期间，SIGCHLD是被阻塞的，好比在说：hi，内核，这会不要给我送SIGCHLD信号，等我忙完再说；<br>在该command执行期间，SIGINT和SIGQUIT是被忽略的，意思是进程收到这两个信号后没有任何动作。</p>
<p>再来看一下system()函数返回值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The value returned is -1 on error (e.g. fork(2) failed), and the return status of the command otherwise. This latter return status is in the format specified in wait(2). Thus, the exit code of the command will be WEXITSTATUS(status). In case /bin/sh could not be executed, the exit status will be that of a command that does exit(127).</span><br><span class="line">If the value of command is NULL, system() returns nonzero if the shell is available, and zero if not.</span><br></pre></td></tr></table></figure></p>
<p>为了更好的理解<code>system()</code>函数返回值，需要了解其执行过程，实际上<code>system()</code>函数执行了三步操作：</p>
<ul>
<li>1.fork一个子进程；</li>
<li>2.在子进程中调用exec函数去执行command；</li>
<li>3.在父进程中调用wait去等待子进程结束。</li>
</ul>
<p>对于<code>fork()</code>失败，<code>system()</code>函数返回-1。<br>如果<code>exec()</code>执行成功，也即command顺利执行完毕，则返回command通过exit或return返回的值。<br>（注意，command顺利执行不代表执行成功，比如<code>command：&quot;rm debuglog.txt&quot;</code>，不管文件存不存在该command都顺利执行了）<br>如果<code>exec()</code>执行失败，也即command没有顺利执行，比如被信号中断，或者command命令根本不存在，<code>system()</code>函数返回127.<br>如果command为NULL，则<code>system()</code>函数返回非0值，一般为1.</p>
<p>看一下<code>system()</code>函数的源码<br>看完这些，我想肯定有人对system()函数返回值还是不清楚，看源码最清楚，下面给出一个<code>system()</code>函数的实现：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">system</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * cmdstring)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">if</span>(cmdstring == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> (<span class="number">1</span>); <span class="comment">//如果cmdstring为空，返回非零值，一般为1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>((pid = fork())&lt;<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		status = <span class="number">-1</span>; <span class="comment">//fork失败，返回-1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		execl(<span class="string">"/bin/sh"</span>, <span class="string">"sh"</span>, <span class="string">"-c"</span>, cmdstring, (<span class="keyword">char</span> *)<span class="number">0</span>);</span><br><span class="line">		_exit(<span class="number">127</span>); <span class="comment">// exec执行失败返回127，注意exec只在失败时才返回现在的进程，成功的话现在的进程就不存在啦~~</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="comment">//父进程</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span>(waitpid(pid, &amp;status, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(errno != EINTR)</span><br><span class="line">			&#123;</span><br><span class="line">				status = <span class="number">-1</span>; <span class="comment">//如果waitpid被信号中断，则返回-1</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> status; <span class="comment">//如果waitpid成功，则返回子进程的返回状态</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>仔细看完这个system()函数的简单实现，那么该函数的返回值就清晰了吧，那么什么时候system()函数返回0呢？只在command命令返回0时。</p>
<p>看一下该怎么监控system()函数执行状态<br>这里给我出的做法：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> status;</span><br><span class="line"><span class="keyword">if</span>(<span class="literal">NULL</span> == cmdstring) <span class="comment">//如果cmdstring为空趁早闪退吧，尽管system()函数也能处理空指针</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> XXX;</span><br><span class="line">&#125;</span><br><span class="line">status = system(cmdstring);</span><br><span class="line"><span class="keyword">if</span>(status &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"cmd: %s\t error: %s"</span>, cmdstring, strerror(errno)); <span class="comment">// 这里务必要把errno信息输出或记入Log</span></span><br><span class="line">    <span class="keyword">return</span> XXX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(WIFEXITED(status))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"normal termination, exit status = %d\n"</span>, WEXITSTATUS(status)); <span class="comment">//取得cmdstring执行结果</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(WIFSIGNALED(status))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"abnormal termination,signal number =%d\n"</span>, WTERMSIG(status)); <span class="comment">//如果cmdstring被信号中断，取得信号值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(WIFSTOPPED(status))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"process stopped, signal number =%d\n"</span>, WSTOPSIG(status)); <span class="comment">//如果cmdstring被信号暂停执行，取得信号值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到于取得子进程返回值的相关介绍可以参考另一篇 <a href="http://my.oschina.net/renhc/blog/35116" target="_blank" rel="noopener">文章</a></p>
<p><code>system()</code>函数用起来很容易出错，返回值太多，而且返回值很容易跟command的返回值混淆。这里推荐使用<code>popen()</code>函数替代，关于<code>popen()</code>函数的简单使用也可以通过上面的链接查看。</p>
<p><code>popen()</code>函数较于<code>system()</code>函数的优势在于使用简单，<code>popen()</code>函数只返回两个值：<br>成功返回子进程的status，使用WIFEXITED相关宏就可以取得command的返回结果；<br>失败返回-1，我们可以使用<code>perro()</code>函数或<code>strerror()</code>函数得到有用的错误信息。</p>
<p>这篇文章只涉及了<code>system()</code>函数的简单使用，还没有谈及SIGCHLD、SIGINT和SIGQUIT对<code>system()</code>函数的影响，事实上，之所以今天写这篇文章，是因为项目中因有人使用了<code>system()</code>函数而造成了很严重的事故。现像是<code>system()</code>函数执行时会产生一个错误：<br>“No child processes”。</p>
<p>关于这个错误的分析，感兴趣的朋友可以看一下<a href="http://my.oschina.net/renhc/blog/54582" target="_blank" rel="noopener">这篇文章</a></p>
<p>原文链接： <a href="http://blog.csdn.net/shanzhizi/article/details/9053953" target="_blank" rel="noopener">http://blog.csdn.net/shanzhizi/article/details/9053953</a></p>
</div><div class="tags"><a href="/blog/tags/C-C/">C/C++</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/blog/post/4e59e7c5.html" class="pre">访问URL时传入另一个URL作为参数</a><a href="/blog/post/e7d93b0c.html" class="next">jQuery.html()和innerHTML在IE8中失效</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/post/16cae89c.html">__declspec关键字详解</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/post/4e59e7c5.html">访问URL时传入另一个URL作为参数</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/post/9ca378c1.html">linux尽量避免使用system()函数,用popen()代替</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/post/e7d93b0c.html">jQuery.html()和innerHTML在IE8中失效</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/post/d49fef81.html">开篇之作</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/前端/">前端</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/后端/">后端</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/杂谈/">杂谈</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/blog/tags/jQuery/" style="font-size: 15px;">jQuery</a> <a href="/blog/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/blog/tags/杂谈/" style="font-size: 15px;">杂谈</a> <a href="/blog/tags/javascript/" style="font-size: 15px;">javascript</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/03/">三月 2018</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.amyge.com/" title="网站首页" target="_blank">网站首页</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/blog/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/blog/atom.xml">订阅</a> |  <a href="/blog/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/blog/." rel="nofollow">Beny.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?1a7c1b84fcea79259304937f7f659bd2";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/blog/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/blog/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script><script>var gitment = new Gitment({
  id: 'Tue Mar 13 2018 17:19:24 GMT+0800',
  owner: 'benyguo',
  repo: 'blog',
  oauth: {
    client_id: '3b34e1bab93b522cc9d2',
    client_secret: 'bea9c2d75e92fd0ebbbe2b7ece8d47899c0c3084',
  },
});
var path = 'post/9ca378c1.html';
if (path != "about/index.html")
  gitment.render('comments');
</script></body></html>